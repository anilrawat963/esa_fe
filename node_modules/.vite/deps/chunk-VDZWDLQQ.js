import {
  r
} from "./chunk-XZMK6YI6.js";
import {
  t
} from "./chunk-AO5WTXLR.js";
import {
  _e,
  oe,
  p,
  te
} from "./chunk-AH42IBBP.js";
import {
  n as n2
} from "./chunk-4PXNA4MD.js";
import {
  a as a2,
  f,
  s as s2
} from "./chunk-PLNHHGHL.js";
import {
  e as e2,
  o
} from "./chunk-C5OQVQZF.js";
import {
  M
} from "./chunk-7P2ANHQ3.js";
import {
  H2 as H
} from "./chunk-V2H77UEV.js";
import {
  n
} from "./chunk-XXLHAM2M.js";
import {
  m
} from "./chunk-5EI5H4QX.js";
import {
  a2 as a
} from "./chunk-ZIE53VIV.js";
import {
  __decorate
} from "./chunk-SS5CLIUY.js";
import {
  e
} from "./chunk-4DGC7CBY.js";
import {
  i3 as i,
  s2 as s
} from "./chunk-QY7XKUIV.js";

// node_modules/@arcgis/core/rest/support/TranslateResult.js
var s3 = class extends n {
  constructor(e3) {
    super(e3), this.text = null, this.detectedLanguage = "en", this.detectedLanguageScore = -1;
  }
};
__decorate([m({ type: String, json: { write: true } })], s3.prototype, "key", void 0), __decorate([m({ type: String, json: { write: true } })], s3.prototype, "text", void 0), __decorate([m({ type: String, json: { read: { source: "detectedLanguage.language" }, write: { target: "detectedLanguage.language" } } })], s3.prototype, "detectedLanguage", void 0), __decorate([m({ type: Number, json: { read: { source: "detectedLanguage.score" }, write: { target: "detectedLanguage.score" } } })], s3.prototype, "detectedLanguageScore", void 0), __decorate([m({ type: Object, json: { write: true } })], s3.prototype, "translation", void 0), s3 = __decorate([a("esri.rest.support.TranslateResult")], s3);

// node_modules/@arcgis/core/rest/translate.js
async function n3(n4, e3, p2) {
  const i3 = e3.toJSON();
  i3.contents = JSON.stringify(i3.contents), i3.token = await a2(e3.portalUrl, e3.apiKey, { signal: p2?.signal, prompt: "no-prompt" !== p2?.authMode });
  const m2 = f(n4), u = s2(m2.query, { ...p2, query: i3, method: "post", authMode: "anonymous" });
  return (await H(m2.path, u)).data.results.map((t2) => s3.fromJSON(t2));
}

// node_modules/@arcgis/core/rest/support/TranslateContent.js
var s4 = class extends n {
  constructor(r2) {
    super(r2);
  }
};
__decorate([m({ type: String, json: { write: true } })], s4.prototype, "key", void 0), __decorate([m({ type: String, json: { write: true } })], s4.prototype, "text", void 0), s4 = __decorate([a("esri.rest.support.TranslateContent")], s4);

// node_modules/@arcgis/core/rest/support/TranslateParameters.js
var i2 = class extends n {
  constructor(t2) {
    super(t2), this.to = null, this.contents = null, this.portalUrl = "https://www.arcgis.com", this.translator = "esri", this.from = null, this.apiKey = null, this.requestSource = null;
  }
};
__decorate([m({ type: [String], json: { write: true } })], i2.prototype, "to", void 0), __decorate([m({ type: [s4], json: { write: true } })], i2.prototype, "contents", void 0), __decorate([m({ type: String, json: { write: true } })], i2.prototype, "portalUrl", void 0), __decorate([m({ type: String, json: { write: true, default: "esri" } })], i2.prototype, "translator", void 0), __decorate([m({ type: String, json: { write: true } })], i2.prototype, "from", void 0), __decorate([m(t)], i2.prototype, "apiKey", void 0), __decorate([m({ type: String, json: { name: "x-esri-request-source" } })], i2.prototype, "requestSource", void 0), i2 = __decorate([a("esri.rest.support.TranslateParameters")], i2);

// node_modules/@arcgis/core/chunks/aiServices.js
var d = class {
  constructor(t2, e3) {
    this.portal = t2, this._debugLog = e3;
  }
  async translate(t2) {
    this.portal.loaded || await this.portal.load();
    const e3 = this.portal.helperServices?.aiUtilityServices;
    if (null == e3) return { success: false };
    const s5 = e3.url + e3.translateUtility;
    try {
      t2.requestSource ??= "arcade";
      return { success: true, results: (await n3(s5, t2, { authMode: "no-prompt" })).map((t3) => t3.toJSON()) };
    } catch (r2) {
      return null != this._debugLog && (r2 instanceof Error || r2 instanceof s) && this._debugLog(`TranslateText error: ${r2.message}`), i.getLogger("esri.arcade.functions.aiServices").error(r2), { success: false };
    }
  }
};
var g = class {
  constructor(t2, e3, s5) {
    this._parameters = t2, this._maxTotalContentSize = e3, this._maxContentsLength = s5, this._requests = [], this._normalizedContents = /* @__PURE__ */ new Map(), this._contentsTotalSize = 0;
  }
  tryAdd(t2) {
    const e3 = new Set(t2.filter((t3) => !this._normalizedContents.has(t3.text)).map((t3) => t3.text));
    if (this._requests.length + e3.size > this._maxContentsLength) return null;
    let s5 = 0;
    for (const n4 of e3) s5 += n4.length;
    if ((s5 + this._contentsTotalSize) * (this._parameters.to.length ?? 1) > this._maxTotalContentSize) return null;
    const r2 = this._requests.length;
    for (const { key: n4, text: o2 } of t2) e(this._normalizedContents, o2, () => []).push({ batchIdx: r2, key: n4 });
    return this._requests.push(t2), this._contentsTotalSize += s5, r2;
  }
  async send(t2) {
    const e3 = [], s5 = [];
    let r2 = 0;
    for (const [i3, c] of this._normalizedContents) e3.push(new s4({ key: String(r2++), text: i3 })), s5.push(c);
    const n4 = new i2(this._parameters);
    n4.contents = e3;
    const o2 = await t2.translate(n4);
    if (!o2.success) return Array.from(this._requests, () => o2);
    const a3 = Array.from(this._requests, () => ({ success: true, results: [] }));
    for (const i3 of o2.results) {
      const t3 = Number(i3.key);
      for (const e4 of s5[t3]) a3[e4.batchIdx].results.push({ ...i3, key: e4.key });
    }
    return a3;
  }
};
function y(t2) {
  const e3 = [...new Set(t2.to)].sort(), s5 = t2.from ?? null, r2 = t2.portalUrl, n4 = t2.translator, o2 = t2.apiKey ?? null;
  return JSON.stringify([e3, s5, r2, n4, o2]);
}
async function w(t2, e3, s5) {
  try {
    return (await t2.yieldFor(s5))[e3];
  } catch {
    return { success: false };
  }
}
var x = class {
  constructor(t2, e3, { maxTotalContentSize: s5 = 5e4, maxContentsLength: r2 = 1e3 } = {}) {
    this._executor = t2, this._service = e3, this._openBatches = /* @__PURE__ */ new Map(), this._maxTotalContentSize = s5, this._maxContentsLength = r2;
  }
  create(t2) {
    return { translate: async (e3) => {
      const s5 = y(e3), { contents: r2, to: n4, from: o2, translator: a3, portalUrl: i3, apiKey: c } = e3;
      if (null == n4) return { success: false };
      if (null == r2 || r2.every((t3) => 0 === t3.text.length)) return { success: false };
      const l = this._openBatches.get(s5);
      if (null != l) {
        const e4 = l.data.tryAdd(r2);
        if (null != e4) return await w(t2, e4, l);
        l.send();
      }
      const u = new g({ to: n4, from: o2, translator: a3, portalUrl: i3, apiKey: c }, this._maxTotalContentSize, this._maxContentsLength), h = u.tryAdd(r2);
      if (null != h) {
        const e4 = this._executor.openBatch(u, { open: (t3) => {
          this._openBatches.set(s5, t3);
        }, execute: (t3) => t3.send(this._service), close: (t3) => {
          this._openBatches.get(s5) === t3 && this._openBatches.delete(s5);
        } });
        return await w(t2, h, e4);
      }
      return await this._service.translate(e3);
    } };
  }
};
function S(a3) {
  "async" === a3.mode && (a3.functions[r("TranslateText")] = function(t2, i3) {
    return a3.standardFunctionAsync(t2, i3, async (t3, a4, i4) => {
      if (oe(i4, 2, 3, t3, a4), !e2(i4[0]) && !o(i4[0]) && !te(i4[0])) throw new n2(t3, "InvalidParameter", a4);
      const c = _e(i4[0]);
      if (!e2(i4[1]) && !o(i4[1]) && !te(i4[1])) throw new n2(t3, "InvalidParameter", a4);
      const u = _e(i4[1]);
      let g2 = null;
      if (i4.length >= 3) {
        if (!e2(i4[2])) throw new n2(t3, "InvalidParameter", a4);
        g2 = i4[2];
      }
      const w2 = c.map((t4, e3) => new s4({ key: String(e3), text: t4 })), x2 = t3.services?.portal ?? M.getDefault(), S2 = new i2({ to: u, contents: w2, from: g2, portalUrl: x2.restUrl.replace(/\/sharing\/rest$/, "") }), T2 = /* @__PURE__ */ new Map();
      let v = null;
      if (null != t3.lrucache) {
        const e3 = t3.lrucache;
        v ??= y(S2), S2.contents = S2.contents?.filter((t4) => {
          const s5 = e3.getCachedTranslation(v, t4.text);
          return null == s5 || (T2.set(t4.key, { ...s5, key: t4.key, text: t4.text }), false);
        });
      }
      if (S2.contents?.length) {
        const r2 = t3.services?.translation ?? new d(x2, t3.console), n4 = await r2.translate(S2);
        if (!n4.success) return new p({ __proto__: null, success: false });
        for (const e3 of n4.results) {
          const r3 = S2.contents?.find((t4) => t4.key === e3.key)?.text;
          if (null == r3) throw new n2(null, "NeverReach", null);
          T2.set(e3.key, e3), null != t3.lrucache && (v ??= y(S2), t3.lrucache.setCachedTranslation(v, r3, { detectedLanguage: e3.detectedLanguage, translation: e3.translation }));
        }
      }
      const C = Array.from(w2, (r2) => {
        const n4 = s3.fromJSON(T2.get(r2.key));
        if (null == n4) throw new n2(null, "NeverReach", null);
        return n4.text = r2.text, p.convertJsonToArcade(n4.toJSON(), t3.timeZone ?? "system", true);
      });
      return new p({ __proto__: null, success: true, results: C });
    });
  });
}
var T = Object.freeze(Object.defineProperty({ __proto__: null, BatchTranslationServiceFactory: x, PortalTranslationService: d, getTranslateParametersKey: y, registerFunctions: S }, Symbol.toStringTag, { value: "Module" }));

export {
  d,
  y,
  x,
  S,
  T
};
//# sourceMappingURL=chunk-VDZWDLQQ.js.map
