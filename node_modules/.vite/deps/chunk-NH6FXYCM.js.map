{
  "version": 3,
  "sources": ["../../@arcgis/core/support/ArcadeExpression.js"],
  "sourcesContent": ["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.34/esri/copyright.txt for details.\n*/\nimport{ArcadeDate as e}from\"../arcade/ArcadeDate.js\";import t from\"../core/Error.js\";import\"../core/has.js\";import{DateOnly as r}from\"../core/sql/DateOnly.js\";import{TimeOnly as i}from\"../core/sql/TimeOnly.js\";import{fromJSON as n}from\"../geometry/support/jsonUtils.js\";import s from\"../layers/support/FieldsIndex.js\";import{loadArcade as a}from\"./loadArcade.js\";import{unknown as o,system as c}from\"../time/constants.js\";const l=[\"geometry\",\"scale\",\"timeProperties\"];function u(e,t){if(null!=t)for(const r of l)t.hasArcadeDependency(r)&&e.add(r);return e}function d(e,t){return p.create(e,t,null,[\"$feature\",\"$view\"])}function h(e,t){return p.create(e,t,null,[\"$feature\",\"$view\"])}function m(e,t,r){return p.create(e,t,r,[\"$feature\",\"$view\",\"$config\"])}class p{static async create(e,r,i,n){const{arcade:s,Dictionary:o}=await a();let c;try{c=s.parseScript(e)}catch(f){throw new t(\"arcade-bad-expression\",\"Failed to parse arcade script\",{script:e,error:f})}const l=s.scriptUsesGeometryEngine(c);l&&await s.enableGeometrySupport(),await s.loadDependentModules(new Set,c,null,!1,l);const u={vars:n.reduce((e,t)=>({...e,[t]:null}),{}),spatialReference:r,useAsync:!1},d=s.compileScript(c,u);let h=null;null!=i&&(h=new o(i),h.immutable=!0);const m=new o;return m.immutable=!1,m.setField(\"scale\",0),new p(e,s,c,d,r,m,h,o)}constructor(e,t,r,i,n,s,a,o){this.script=e,this._arcade=t,this._syntaxTree=r,this._compiled=i,this._spatialReference=n,this._viewDict=s,this._configDict=a,this._dictionaryCtor=o,this._dependencies=new Map,this._featureReader=new f,this._dependencies.set(\"geometry\",t.scriptTouchesGeometry(this._syntaxTree)),this._dependencies.set(\"scale\",this._arcade.referencesMember(this._syntaxTree,\"scale\")),this._dependencies.set(\"timeProperties\",this._arcade.scriptUsesViewProperties(this._syntaxTree,[\"timeProperties\"]))}evaluate(t,r){const i=r.$view?.timeZone;if(r.$view){let t;if(this._viewDict.setField(\"scale\",r.$view.scale),null!=r.$view.timeProperties){const{currentStart:n,currentEnd:s}=r.$view.timeProperties;t=new this._dictionaryCtor({currentStart:null!=n?null!=i?e.epochToArcadeDate(n,i):e.unknownEpochToArcadeDate(n):void 0,currentEnd:null!=s?null!=i?e.epochToArcadeDate(s,i):e.unknownEpochToArcadeDate(s):void 0,startIncluded:!0,endIncluded:!0})}this._viewDict.setField(\"timeProperties\",t)}return this._compiled({vars:{$view:this._viewDict,$config:this._configDict,$feature:t},spatialReference:this._spatialReference,timeZone:i})}repurposeFeature(e,t){return this._featureReader.bind(e,t,this._spatialReference),this._featureReader}references(e){return this._dependencies.get(e)??!1}}class f{constructor(){this._boundTarget=null,this._boundSchema={fields:null,fieldsIndex:null,spatialReference:null,get geometryType(){return null},get objectIdField(){return null}},this.arcadeDeclaredClass=\"esri.arcade.Feature\",this._contextTimeZone=null}bind(e,t,r){const i=t??new s(_(e.attributes));this._boundTarget=e,this._boundSchema.fields=i.fields,this._boundSchema.fieldsIndex=i,this._boundSchema.spatialReference=r}_getField(e){return this._boundSchema.fieldsIndex.get(e)}get contextTimeZone(){return this._contextTimeZone}set contextTimeZone(e){this._contextTimeZone=e}readArcadeFeature(){return this}hasField(e){return this._boundSchema.fieldsIndex.has(e)}geometry(){if(\"fromJSON\"in this._boundTarget)return this._boundTarget.geometry;const e=n(this._boundTarget.geometry);if(e){if(!this._boundSchema.spatialReference)throw new Error(\"InternalError: Expected spatial reference to be defined\");e.spatialReference=this._boundSchema.spatialReference}return e}_hasGeometry(){return null!=this._boundTarget.geometry}isUnknownDateTimeField(e){return this._boundSchema.fieldsIndex.getTimeZone(e)===o}field(t,n=!0){const s=this._getField(t);if(s){const n=this._boundTarget.attributes[s.name];if(null==n)return null;switch(s.type){case\"date-only\":case\"esriFieldTypeDateOnly\":return r.fromReader(n);case\"time-only\":case\"esriFieldTypeTimeOnly\":return i.fromReader(n);case\"esriFieldTypeTimestampOffset\":case\"timestamp-offset\":return e.fromReaderAsTimeStampOffset(n);case\"date\":case\"esriFieldTypeDate\":return this.isUnknownDateTimeField(t)?e.unknownEpochToArcadeDate(n):e.epochToArcadeDate(n,this.contextTimeZone??c);default:return n}}if(n)throw new Error(`Field ${t} does not exist`);return null}setField(e,t){throw new Error(\"Unable to update feature attribute values, feature is readonly\")}keys(){return this._boundSchema.fieldsIndex.fields.map(e=>e.name)}isEmpty(){return this._boundSchema.fields.length<=0&&!this._hasGeometry()}castToText(e=!1){return JSON.stringify(this._boundTarget)}gdbVersion(){return null}fullSchema(){return this._boundSchema}castAsJson(e=null){return{attributes:this._boundTarget.attributes,geometry:!0===e?.keepGeometryType?this.geometry():this.geometry()?.toJSON()??null}}castAsJsonAsync(e=null,t=null){return Promise.resolve(this.castAsJson(t))}}function _(e){const t=[];for(const r in e)t.push({name:r,alias:r,type:\"string\"==typeof e[r]?\"esriFieldTypeString\":\"esriFieldTypeDouble\"});return t}export{p as ArcadeExpression,f as ArcadeFeatureReader,u as collectExpressionDependencies,m as createDictionaryExpression,d as createLabelExpression,h as createRendererExpression,_ as deriveFields};\n"],
  "mappings": "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",
  "names": ["e", "t", "r", "e", "t", "m", "r", "i", "s", "f", "l", "u", "h", "n"]
}
