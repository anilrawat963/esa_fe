import {
  n
} from "./chunk-D2MXQDQ2.js";
import {
  E
} from "./chunk-VUC34XNV.js";
import {
  R,
  j as j2,
  w
} from "./chunk-GD72EK2J.js";
import {
  o as o2
} from "./chunk-SL3GC7WV.js";
import {
  l as l2
} from "./chunk-CJZPTLIZ.js";
import {
  s as s2
} from "./chunk-ZETARPSI.js";
import {
  b2 as b,
  m as m2,
  y
} from "./chunk-CZOYDK6P.js";
import {
  j
} from "./chunk-6TCXGIIN.js";
import {
  l
} from "./chunk-NP2TBOXH.js";
import "./chunk-H34D76ZQ.js";
import "./chunk-ET5EDAFM.js";
import "./chunk-VYMBX5H5.js";
import {
  t as t2
} from "./chunk-W5S3VUFT.js";
import "./chunk-7YH7T6CS.js";
import "./chunk-3T4IXPP4.js";
import "./chunk-XTZAIV4X.js";
import "./chunk-63LDVRFI.js";
import "./chunk-MC6NAKKX.js";
import "./chunk-TF6255HN.js";
import "./chunk-C5OQVQZF.js";
import {
  j as j3
} from "./chunk-U3X2LY5C.js";
import "./chunk-JRCD3NNE.js";
import "./chunk-NPYFNHY2.js";
import "./chunk-JW6DU3OK.js";
import {
  t
} from "./chunk-CNYNCKEV.js";
import "./chunk-XL5QPCXN.js";
import "./chunk-2LC2762W.js";
import "./chunk-W6HOAVT4.js";
import "./chunk-DTZUXJMD.js";
import "./chunk-YLAGKT2D.js";
import "./chunk-6YRQYUCY.js";
import "./chunk-W75DBJD7.js";
import "./chunk-QF7FRVN6.js";
import {
  b as b2
} from "./chunk-P6IKJIMO.js";
import "./chunk-MHV23XAQ.js";
import "./chunk-LPZUGJNG.js";
import "./chunk-W6J7XCPU.js";
import "./chunk-ONXWBTTM.js";
import "./chunk-T7F6Q6JJ.js";
import "./chunk-YDTPM7OQ.js";
import "./chunk-75XOUSSS.js";
import "./chunk-TH4EQWJJ.js";
import {
  M
} from "./chunk-7P2ANHQ3.js";
import "./chunk-XCKT47LJ.js";
import "./chunk-3FUHCAX3.js";
import "./chunk-PZ5RULLK.js";
import "./chunk-OPJX4KXH.js";
import "./chunk-LTPHDYPK.js";
import "./chunk-3OVERDFX.js";
import "./chunk-FPMLKIDB.js";
import "./chunk-AZXJIEZ6.js";
import "./chunk-Q75WYS7K.js";
import {
  z
} from "./chunk-H74Q4SYB.js";
import {
  U,
  a as a2
} from "./chunk-2OFHDVO5.js";
import "./chunk-TFJXG32O.js";
import "./chunk-DDOCCRD4.js";
import "./chunk-5UPBUJPC.js";
import "./chunk-THQO67BJ.js";
import "./chunk-4YDOPHTZ.js";
import "./chunk-YY5PITIH.js";
import "./chunk-SMWUT52Z.js";
import "./chunk-AXZMNHTN.js";
import {
  f as f2
} from "./chunk-5T3MJDSR.js";
import "./chunk-NMQNUPE4.js";
import "./chunk-6KIXN4DJ.js";
import "./chunk-7DGJB37R.js";
import "./chunk-234CIOHE.js";
import {
  H2 as H,
  p
} from "./chunk-V2H77UEV.js";
import "./chunk-WRA2WBYC.js";
import {
  o
} from "./chunk-XWE6BM2U.js";
import "./chunk-SOIZOFSB.js";
import "./chunk-XXLHAM2M.js";
import {
  m
} from "./chunk-5EI5H4QX.js";
import {
  a2 as a
} from "./chunk-ZIE53VIV.js";
import {
  __decorate
} from "./chunk-SS5CLIUY.js";
import "./chunk-R54Q5TGA.js";
import "./chunk-6SSZNBOK.js";
import "./chunk-LZ2XTYP2.js";
import "./chunk-45CFSCQX.js";
import "./chunk-A5XN2VFT.js";
import "./chunk-65HD3WXL.js";
import "./chunk-4DGC7CBY.js";
import {
  f2 as f
} from "./chunk-GNMPGHLQ.js";
import {
  i3 as i,
  s2 as s
} from "./chunk-QY7XKUIV.js";
import "./chunk-AL6YUTZM.js";
import "./chunk-G26ADAPQ.js";

// node_modules/@arcgis/core/layers/IntegratedMesh3DTilesLayer.js
var D = class extends l2(b(j(t2(l(s2(o2(b2))))))) {
  readModifications(e, t3, o3) {
    this._modificationsSource = { url: p(e, o3), context: o3 };
  }
  initialize() {
    this.addHandles(a2(() => this.modifications, "after-changes", () => this.modifications = this.modifications, U));
  }
  constructor(e) {
    super(e), this.operationalLayerType = "IntegratedMesh3DTilesLayer", this.modifications = null, this._modificationsSource = null, this.spatialReference = new f2({ wkid: 4326, vcsWkid: 115700 }), this.fullExtent = new z(-180, -90, 180, 90, this.spatialReference), this.url = null, this.type = "integrated-mesh-3dtiles", this.path = null, this.minScale = 0, this.maxScale = 0, this._rootTilesetJSON = null, this._rootTileset = null, this._key = null, this._session = null, this._rootRequestPromise = null;
  }
  set elevationInfo(e) {
    null != e && "absolute-height" !== e.mode || this._set("elevationInfo", e), this._validateElevationInfo(e);
  }
  async load(e) {
    return this.addResolvingPromise(this._doLoad(e)), this;
  }
  get rootTilesetJSON() {
    return this._rootTilesetJSON;
  }
  get rootTileset() {
    return this._rootTileset;
  }
  get key() {
    return this._key;
  }
  get session() {
    return this._session;
  }
  _findSessionParameter(e) {
    const t3 = [e];
    for (; t3?.length > 0; ) {
      const e2 = t3.pop();
      if (!e2) return;
      for (const [r, i2] of Object.entries(e2)) {
        if ("uri" === r) try {
          const e3 = new URL("https://tmp" + i2).searchParams.get("session");
          if (e3) return e3;
        } catch (o3) {
        }
        "object" == typeof i2 && null !== i2 && t3.push(i2);
      }
    }
    return null;
  }
  async requestRootAndSession(e) {
    const i2 = (e2, t3) => new s("3dtiles-init:" + e2, t3);
    return this._rootRequestPromise || (this._rootRequestPromise = new Promise((o3, n2) => {
      this.url || n2(i2("url-missing", "Layer url missing")), this._key = this.customParameters ? this.customParameters.key : null;
      new Promise((e2, o4) => {
        if (this.replacesTerrain && !this._key) {
          const r = this.portalItem?.portal || this.parent?.portalItem?.portal || M.getDefault();
          r.signIn().then(() => {
            r.g3dTilesEnabled ? H(r.restUrl + "/portals/self/modules/g3dtiles", { responseType: "json", query: { f: "json" } }).then((t3) => {
              this._key = t3.data.keyString, e2();
            }, () => o4(i2("g3dtiles-key-error", "Error fetching Google 3D Tiles key from portal"))) : o4(i2("g3dTilesEnabled-false", "Google 3D Tiles are not enabled on Portal " + r.url));
          }, () => o4(i2("sign-in-failed", "Error signing in to Portal")));
        } else e2();
      }).then(() => {
        H(this.url, { query: this._key ? { key: this._key, token: this.apiKey } : { token: this.apiKey }, responseType: "array-buffer", signal: e }).then((e2) => {
          try {
            this._rootTilesetJSON = JSON.parse(new TextDecoder().decode(e2.data));
          } catch (t3) {
            return void n2(i2("root-parse-failed", "Error parsing root tile, details: " + t3));
          }
          this._rootTilesetJSON ? (this._session = this._findSessionParameter(this._rootTilesetJSON), this._rootTileset = e2.data, this.fullExtent = E(this._rootTilesetJSON), o3(), this._rootRequestPromise = null) : n2(i2("root-is-null", "Root tile is null."));
        }, (e2) => {
          f(e2), n2(i2("root-load-failed", "Error loading root tile")), this._rootRequestPromise = null, i.getLogger("IntegratedMesh3DTilesLayer").error("Layer loading failed", e2);
        });
      }, (e2) => n2(e2));
    })), this._rootRequestPromise;
  }
  async _doLoad(e) {
    const t3 = null != e ? e.signal : null;
    if (this._isUsedAsGroundLayer) throw new s("3dtiles-init:not-supported-in-groundlayers", "Layer is not supported in basemap.");
    try {
      await this.loadFromPortal({ supportedTypes: ["3DTiles Service"], validateItem: (e2) => {
        if (e2.typeKeywords?.includes("IntegratedMesh")) return true;
        throw new s("portal:invalid-layer-item-type", "Invalid layer item, expected '${expectedType}' ", { expectedType: "3DTiles Service containing IntegratedMesh" });
      } }, e);
    } catch (r) {
      f(r);
    }
    if (null != this._modificationsSource) {
      const t4 = await n.fromUrl(this._modificationsSource.url, this.spatialReference, e);
      this.setAtOrigin("modifications", t4, this._modificationsSource.context.origin), this._modificationsSource = null;
    }
    await this.requestRootAndSession(t3);
  }
  beforeSave() {
    if (null != this._modificationsSource) return this.load().then(() => {
    }, () => {
    });
  }
  get hasAttributionData() {
    return false;
  }
  async fetchAttributionData() {
    return {};
  }
  _validateElevationInfo(e) {
    const t3 = "Integrated mesh 3d tiles layers";
    j2(i.getLogger(this), w(t3, "absolute-height", e)), j2(i.getLogger(this), R(t3, e));
  }
  get replacesTerrain() {
    return false;
  }
  get _isUsedAsGroundLayer() {
    return t(this.parent);
  }
  get hasGoogleUrl() {
    return !!this.url?.match(/.+\.googleapis.com/);
  }
};
__decorate([m({ type: ["IntegratedMesh3DTilesLayer"] })], D.prototype, "operationalLayerType", void 0), __decorate([m({ type: n, clonable: (e) => e.clone() }), j3({ origins: ["web-scene", "portal-item"], type: "resource", prefix: "modifications" })], D.prototype, "modifications", void 0), __decorate([o(["web-scene", "portal-item"], "modifications")], D.prototype, "readModifications", null), __decorate([m({ type: f2 })], D.prototype, "spatialReference", void 0), __decorate([m({ type: z })], D.prototype, "fullExtent", void 0), __decorate([m(m2)], D.prototype, "elevationInfo", null), __decorate([m({ type: ["show", "hide"] })], D.prototype, "listMode", void 0), __decorate([m(y)], D.prototype, "url", void 0), __decorate([m({ readOnly: true })], D.prototype, "type", void 0), __decorate([m({ type: String, json: { origins: { "web-scene": { read: true, write: true }, "portal-item": { read: true, write: true } }, read: false } })], D.prototype, "path", void 0), __decorate([m({ type: Number, json: { name: "layerDefinition.minScale", write: true, origins: { service: { read: false, write: false } } } })], D.prototype, "minScale", void 0), __decorate([m({ type: Number, json: { name: "layerDefinition.maxScale", write: true, origins: { service: { read: false, write: false } } } })], D.prototype, "maxScale", void 0), __decorate([m()], D.prototype, "replacesTerrain", null), __decorate([m()], D.prototype, "_isUsedAsGroundLayer", null), __decorate([m()], D.prototype, "hasGoogleUrl", null), D = __decorate([a("esri.layers.IntegratedMesh3DTilesLayer")], D);
var O = D;
export {
  O as default
};
//# sourceMappingURL=IntegratedMesh3DTilesLayer-M67ZPH6Y.js.map
