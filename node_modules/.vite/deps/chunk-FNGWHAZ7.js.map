{
  "version": 3,
  "sources": ["../../@arcgis/core/views/2d/viewStateUtils.js", "../../@arcgis/core/views/2d/layers/support/ExportStrategy.js"],
  "sourcesContent": ["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.34/esri/copyright.txt for details.\n*/\nconst t=Math.PI/180;function n(n){return n*t}function o(t,o){const a=n(o.rotation),r=Math.abs(Math.cos(a)),s=Math.abs(Math.sin(a)),[u,c]=o.size;return t[0]=Math.round(c*s+u*r),t[1]=Math.round(c*r+u*s),t}function a(t,n,o,a){const[r,s]=n,[u,c]=a,h=.5*o;return t[0]=r-h*u,t[1]=s-h*c,t[2]=r+h*u,t[3]=s+h*c,t}export{a as getBBox,o as getOuterSize};\n", "/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.34/esri/copyright.txt for details.\n*/\nimport{__decorate as t}from\"tslib\";import e from\"../../../../core/Accessor.js\";import\"../../../../core/has.js\";import{debounce as i,throwIfAborted as o,throwIfAbortError as r,eachAlways as s}from\"../../../../core/promiseUtils.js\";import{property as a}from\"../../../../core/accessorSupport/decorators/property.js\";import\"../../../../core/Logger.js\";import\"../../../../core/RandomLCG.js\";import{subclass as p}from\"../../../../core/accessorSupport/decorators/subclass.js\";import{toExtent as n,create as m}from\"../../../../geometry/support/aaBoundingRect.js\";import{getInfo as d}from\"../../../../geometry/support/spatialReferenceUtils.js\";import h from\"../../../../layers/support/TileInfo.js\";import{getOuterSize as l,getBBox as c}from\"../../viewStateUtils.js\";import{Bitmap as u}from\"../../engine/Bitmap.js\";import g from\"../../tiling/TileInfoView.js\";import f from\"../../tiling/TileKey.js\";const y=m(),x=[0,0],S=new f(0,0,0,0),w={imageMaxWidth:2048,imageMaxHeight:2048,imageRotationSupported:!1,imageNormalizationSupported:!1,hidpi:!1};let M=class extends e{constructor(t){super(t),this._imagePromise=null,this.bitmaps=[],this.hidpi=w.hidpi,this.imageMaxWidth=w.imageMaxWidth,this.imageMaxHeight=w.imageMaxHeight,this.imageRotationSupported=w.imageRotationSupported,this.imageNormalizationSupported=w.imageNormalizationSupported,this.update=i(async(t,e)=>{if(o(e),!t.stationary||this.destroyed)return;const i=t.state,s=d(i.spatialReference),a=this.hidpi?t.pixelRatio:1,p=i.worldScreenWidth>0,n=p&&this.imageNormalizationSupported&&i.worldScreenWidth<i.size[0],m=Math.round((this.imageMaxWidth??0)/a),h=Math.round((this.imageMaxHeight??0)/a);n?(x[0]=i.worldScreenWidth,x[1]=i.size[1]):this.imageRotationSupported?(x[0]=i.size[0],x[1]=i.size[1]):l(x,i);const c=Math.floor(x[0])>m||Math.floor(x[1])>h,u=s&&(i.extent.xmin<s.valid[0]||i.extent.xmax>s.valid[1]),g=!this.imageNormalizationSupported&&u,f=!c&&!g,y=this.imageRotationSupported?i.rotation:0,S=this.container.children.slice();if(f){const t=n?i.paddedViewState.center:i.center;this._imagePromise=this._singleExport(i,x,t,i.resolution,y,a,e)}else{let t=Math.min(m,h);p&&(t=Math.min(i.worldScreenWidth,t),t=Math.round(i.worldScreenWidth/Math.ceil(i.worldScreenWidth/t))),this._imagePromise=this._tiledExport(i,t,a,e)}try{const t=await this._imagePromise??[];o(e);const i=[];if(this._imagePromise=null,this.destroyed)return;this.bitmaps=t;for(const e of S)t.includes(e)||i.push(e.fadeOut().then(()=>{e.remove(),e.destroy()}));for(const e of t)i.push(e.fadeIn());await Promise.all(i)}catch(w){this._imagePromise=null,r(w)}},5e3),this.updateExports=i(async t=>{const e=[];for(const i of this.container.children){if(!i.visible||!i.stage)return;e.push(t(i).then(()=>{i.invalidateTexture(),i.requestRender()}))}this._imagePromise=s(e).then(()=>this._imagePromise=null),await this._imagePromise})}destroy(){this.bitmaps.forEach(t=>t.destroy()),this.bitmaps=[]}get updating(){return!this.destroyed&&null!==this._imagePromise}async _export(t,e,i,r,s,a){const p=await this.fetchSource(t,Math.floor(e*s),Math.floor(i*s),{rotation:r,pixelRatio:s,signal:a});o(a);const n=new u(null,!0);return n.x=t.xmin,n.y=t.ymax,n.resolution=t.width/e,n.rotation=r,n.pixelRatio=s,n.opacity=0,this.container.addChild(n),await n.setSourceAsync(p,a),o(a),n}async _singleExport(t,e,i,o,r,s,a){c(y,i,o,e);const p=n(y,t.spatialReference);return[await this._export(p,e[0],e[1],r,s,a)]}_tiledExport(t,e,i,o){const r=h.create({size:e,spatialReference:t.spatialReference,scales:[t.scale]}),s=new g(r),a=s.getTileCoverage(t);if(!a)return null;const p=[];return a.forEach((r,a,m,d)=>{S.set(r,a,m,0),s.getTileBounds(y,S);const h=n(y,t.spatialReference);p.push(this._export(h,e,e,0,i,o).then(t=>(0!==d&&(S.set(r,a,m,d),s.getTileBounds(y,S),t.x=y[0],t.y=y[3]),t)))}),Promise.all(p)}};t([a()],M.prototype,\"_imagePromise\",void 0),t([a()],M.prototype,\"bitmaps\",void 0),t([a()],M.prototype,\"container\",void 0),t([a()],M.prototype,\"fetchSource\",void 0),t([a()],M.prototype,\"hidpi\",void 0),t([a()],M.prototype,\"imageMaxWidth\",void 0),t([a()],M.prototype,\"imageMaxHeight\",void 0),t([a()],M.prototype,\"imageRotationSupported\",void 0),t([a()],M.prototype,\"imageNormalizationSupported\",void 0),t([a()],M.prototype,\"requestUpdate\",void 0),t([a()],M.prototype,\"updating\",null),M=t([p(\"esri.views.2d.layers.support.ExportStrategy\")],M);export{M as default};\n"],
  "mappings": "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",
  "names": ["n", "t", "o", "a", "s", "c", "h", "w", "t", "e", "i", "s", "a", "n", "m", "h", "c", "f", "y", "S", "o", "r"]
}
