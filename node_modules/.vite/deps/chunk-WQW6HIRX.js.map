{
  "version": 3,
  "sources": ["../../@arcgis/core/layers/support/TitleCreator.js"],
  "sourcesContent": ["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.34/esri/copyright.txt for details.\n*/\nimport{__decorate as e}from\"tslib\";import t from\"../../core/Accessor.js\";import{isSome as s}from\"../../core/arrayUtils.js\";import{createTask as i}from\"../../core/asyncUtils.js\";import r from\"../../core/Collection.js\";import{stripHTMLSanitizer as a}from\"../../core/sanitizerUtils.js\";import{property as o}from\"../../core/accessorSupport/decorators/property.js\";import\"../../core/has.js\";import\"../../core/Logger.js\";import{subclass as l}from\"../../core/accessorSupport/decorators/subclass.js\";import{featureHasFields as n,extractSubstitutionTemplatesFromString as c}from\"./fieldUtils.js\";import{loadArcade as d}from\"../../support/loadArcade.js\";const p=\"relationships/\",u=\"expression/\",f=/<br\\s*\\/*>/gi;let h=class extends t{constructor(e){super(e),this._featureUtils=null,this.effectivePopupTemplate=null}get _arcadeTask(){if(this.expressionsUsedInTitle.length>0){return this._get(\"_arcadeTask\")||i(()=>d())}return null}get featureUtilsPromise(){return this._get(\"featureUtilsPromise\")??import(\"../../widgets/Feature/support/featureUtils.js\").then(e=>this._featureUtils=e)}get calculatedExpressions(){const e=new r;if(!this.expressionsUsedInTitle.length)return e;if(!this._arcadeTask?.value){for(const t of this.expressionsUsedInTitle??[])e.push({name:t.name,invalid:!0});return e}for(const t of this.expressionsUsedInTitle)try{const s=this._arcadeTask.value.arcade.parseScript(t.expression,[\"$layer\",\"$map\",\"$datastore\"]);if(s.isAsync){e.push({name:t.name,invalid:!0});break}e.push({name:t.name,syntax:s,invalid:!1,func:this._arcadeTask.value.arcade.compileScript(s,{vars:{$feature:\"any\"}})})}catch{e.push({name:t.name,invalid:!0});break}return e}get expressionsUsedInTitle(){let e=this.effectivePopupTemplate?.title??\"\";return\"string\"!=typeof e?[]:(e=e.toLowerCase(),this.effectivePopupTemplate?.expressionInfos?.filter(t=>e.includes(`{expression/${t.name.toLowerCase()}}`))??[])}get fieldInfoMap(){return this._featureUtils?this._createFieldInfoMap(this._featureUtils.getAllFieldInfos(this.effectivePopupTemplate)):null}get hasBadExpressions(){return this.calculatedExpressions.some(e=>!0===e.invalid)}get requiredFields(){const e=new Set;if(this._arcadeTask?.value&&!this.hasBadExpressions)for(const s of this.calculatedExpressions?.toArray()??[])try{const t=this._arcadeTask.value.arcade.extractFieldLiterals(s.syntax);for(const s of t){const t=s.split(\".\"),i=this.fieldsIndex.get(t.at(-1)??\"\");i&&e.add(i.name)}}catch{}const t=this._extractFieldNames(this.workingTitle);for(const s of t){const t=this.fieldsIndex.get(s);t&&e.add(t.name)}return null!=this.objectIdField&&e.add(this.objectIdField),e}get titleFromDisplayField(){let e=\"\";return this.displayField&&(e=this.fieldsIndex.get(this.displayField)?.name??\"\"),e||(e=this.fieldsIndex.get(this.objectIdField)?.name??\"\"),e?`{${e}}`:\"\"}get workingTitle(){const e=this.effectivePopupTemplate?this.effectivePopupTemplate.title:\"\";return\"\"===e||null==e||this.hasBadExpressions||\"string\"!=typeof e?this.titleFromDisplayField:e}async getTitle(e,t,s){const i=t.getObjectId()??t.attributes[e.objectIdField];return(await this.getTitles(e,[t],s)).get(i)??\"\"}async getTitles(e,t,s){const i=new Map,r=s?.timeZone??\"system\";try{const[{substituteFieldsInLinksAndAttributes:o}]=await Promise.all([this.featureUtilsPromise,this._arcadeTask?.promise]);s?.fetchMissingFields&&(t=await this._checkAndReQueryGraphics(e,t));const{fieldInfoMap:l,workingTitle:n}=this,c=n&&l;t.forEach(t=>{const d=t.getObjectId()??t.attributes[e.objectIdField];let p=c?o({attributes:t.attributes,expressionAttributes:null,fieldInfoMap:l,globalAttributes:this._createFormattedAttributes(e,t,r).global,layer:e,text:n}):\"\";s?.removeHTML&&(p=a.sanitize(p).replaceAll(f,\" \")),i.set(d,p)})}catch{}return i}async _checkAndReQueryGraphics(e,t){const i=t.map(t=>t.getObjectId()??t.attributes[e.objectIdField]).filter(s);if(i.length!==t.length)return t;if(t.some(e=>!n(e,this.requiredFields))){const s=e.createQuery();s.where=\"1=1\",s.outFields=[...this.requiredFields],s.objectIds=i;const r=await e.queryFeatures(s);if(r?.features.length===t.length)return r.features}return t}_createFieldInfoMap(e){const t=new Map;if(!e)return t;for(const s of e){if(!s.fieldName)continue;const e=this.fieldsIndex.get(s.fieldName),i=e?.name??s.fieldName;s.fieldName=i,t.set(i.toLowerCase(),s)}return t}_createFormattedAttributes(e,t,s=\"system\"){const i=this.effectivePopupTemplate?.fieldInfos??[],r={};if(!this._featureUtils)return{};if(!this.hasBadExpressions&&this.calculatedExpressions.length>0&&this._arcadeTask?.value){const s=this._arcadeTask.value.Feature.createFromGraphicLikeObject(t.geometry,t.attributes,e,null);for(const e of this.calculatedExpressions)try{r[`expression/${e.name}`]=e.func({vars:{$feature:s}})}catch{}}const a={...t.attributes,...r};return{global:this._featureUtils.formatAttributes({fieldInfos:i,attributes:a,graphic:t,timeZone:s,layer:e,fieldInfoMap:this.fieldInfoMap}),content:[]}}_extractFieldNames(e){return c(e).filter(e=>!(e.startsWith(p)||e.startsWith(u)))}};e([o({readOnly:!0})],h.prototype,\"_arcadeTask\",null),e([o()],h.prototype,\"_featureUtils\",void 0),e([o({readOnly:!0})],h.prototype,\"featureUtilsPromise\",null),e([o({readOnly:!0})],h.prototype,\"calculatedExpressions\",null),e([o()],h.prototype,\"displayField\",void 0),e([o()],h.prototype,\"effectivePopupTemplate\",void 0),e([o()],h.prototype,\"expressionsUsedInTitle\",null),e([o()],h.prototype,\"fieldsIndex\",void 0),e([o()],h.prototype,\"fieldInfoMap\",null),e([o()],h.prototype,\"fields\",void 0),e([o()],h.prototype,\"objectIdField\",void 0),e([o()],h.prototype,\"requiredFields\",null),h=e([l(\"esri.layers.support.TitleCreator\")],h);export{h as default};\n"],
  "mappings": "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",
  "names": ["e", "s", "t", "d", "p", "a"]
}
